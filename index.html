<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <script src="/jquery.js"></script>
    </head>
    <body onload="handleRequest()">
        <p style="font-size:xx-large;" id="response"></p>

        <script>
            async function handleRequest() {
    
                //Get request body from string query
                let request = {};
                var kvPairs = location.search.slice(1).split('&');
                kvPairs.forEach((pair) => {
                    pair = pair.split('=');
                    request[pair[0]] = decodeURIComponent(pair[1] || '');
                });
    
                //Set status to working. This tells the front end to continue polling (scraping) for changes. Helpful for asynchronous or heavy workloads.
                resPrint({
                    status: 300,
                    message: 'working'
                })

                //Switch case for different endpoints
                switch (request?.endpoint) {
                    //Checking connection
                    case 'checkConnection':
                        //Client is just making sure they can communicate, so respond status good.
                        resPrint({
                            status: 200,
                            message: 'connected'
                        });
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            status: 200,
                            endpoint: 'checkConnection',
                            message: 'connected'
                        }));
                        break;


                    //Serve an array of network objects that have an SSID and RSSI
                    case 'getNetworks':
                        //Get networks
                        let rawNetworks = [{SSID:'Network 1',RSSI:'10'}, {SSID:'Network 2',RSSI:'7'}, {SSID:'Network 3',RSSI:'5'}, {SSID:'Network 4',RSSI:'2'}];

                        //Print to DOM so frontend can scrape
                        resPrint({
                            status: 200,
                            message: 'success',
                            networks: rawNetworks
                        });

                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            status: 200,
                            endpoint: 'getNetworks',
                            message: 'success',
                            networks: rawNetworks 
                        }));

                        break;
                    
                    case 'listenForNetworks':
                        //Get and return data immediately
                        $.getJSON('./ap.json', (data) => {
                            if(data.length > 0){
                                //sort by signal strength
                                data.sort(function (a, b) {
                                    var x = a["rssi"]; var y = b["rssi"];
                                    return ((x < y) ? 1 : ((x > y) ? -1 : 0));
                                });
                            }
                            resPrint(JSON.stringify(data));
                            res(JSON.stringify(data));
                        })

                        //Update data every second
                        setInterval(() => {
                            $.getJSON('./ap.json', (data) => {
                                if(data.length > 0){
                                    //sort by signal strength
                                    data.sort(function (a, b) {
                                        var x = a["rssi"]; var y = b["rssi"];
                                        return ((x < y) ? 1 : ((x > y) ? -1 : 0));
                                    });
                                }
                            })
                        }, 3000)
                        break;


                    case 'connectToNetwork':
                        //Make sure they sent an SSID in the request
                        if (!!request?.SSID ) {
                            //Try to connect to network here
                            resPrint({
                                status: 200,
                                message: 'Attempting connection to ' + request.SSID
                            })
                        } 

                        else {
                            //Bad request
                            resPrint({
                                status: 400,
                                message: 'BAD_REQUEST'
                            })
                        }
                        break;
                        
                
                    default:
                        //Bad request. Either no endpoint or invalid endpoint name
                        resPrint({
                            status: 400,
                            message: 'BAD_REQUEST'
                        })
                        break;
                }
    
            }


            // HELPERS
            //Print endpoint response to DOM for easy debugging
            function resPrint(body) {
                document.getElementById("response").innerHTML = JSON.stringify(body);
            }

            //Send data to react native client
            function res(body) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ ...body }));
            }

        </script>
    </body>
</html>